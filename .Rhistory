meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lrg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] pdInfo
}
}
}
}
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
if(length(na.omit(conductance)) > 0 && all(conductance > 0.8)){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lrg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
if(length(na.omit(conductance)) > 0 && all(conductance > 0.8)){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
conductance
length(na.omit(conductance))
length(na.omit(conductance)) > 0
all(conductance > 0.8)
cond_na_omit = as.numeric(na.omit(conductance))
cond_na_omit
cond_na_omit = as.numeric(na.omit(conductance))
if(length(cond_na_omit) > 0 && all(cond_na_omit > 0.8)){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
cond_na_omit
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, cell_id=NA, outcome_dmso=NA, outcome_c18=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
cond_na_omit = as.numeric(na.omit(conductance))
if(length(cond_na_omit) > 0 && all(cond_na_omit > 0.8)){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
info
info[order(info$pert_id),]
conductance
is.na(conductance)
any(is.na(conductance))
!any(is.na(conductance))
if(!any(is.na(conductance)) && all(conductance > 0.8)){print('yeah')}
length(meanSigs$none)
dim(info)
info
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, cell_id=NA, outcome_dmso=NA, outcome_c18=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
if(!any(is.na(conductance)) && all(conductance > 0.8)){
#cond_na_omit = as.numeric(na.omit(conductance))
#if(length(cond_na_omit) > 0 && all(cond_na_omit > 0.8)){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2]))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
info
S$sm = lapply(meanSigs, function(x){out = laply(x, identity); rownames(out) = names(x); return(out)})
dim(S$sm$none)
S$sm$none[1:5,1:5]
info
info = info[-1,]
head(info)
allInfo$`BRD-K18812295_10uM`
dim(allInfo$`BRD-K18812295_10uM`)
info
head(info)
plot(info$outcome_dmso, info$outcome_c18)
cor(info$outcome_dmso, info$outcome_c18)
abline(0,1)
NA > 0.8
!is.na(NA) && NA > 0.8
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, cell_id=NA, outcome_dmso=NA, outcome_c18=NA, mean_response=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
mean_response = mean(conductance, na.rm=TRUE)
#if(!any(is.na(conductance)) && all(conductance > 0.8)){
if(!is.na(mean_response) && mean_response > 0.8){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2], mean_response))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
info = info[-1,]
info
plot(info$outcome_dmso, info$outcome_c18)
abline(0, 1)
# Identify relevant experiments (measured drug/dose combinations with conductance not too low)
C = drugData$outcomes
dose_cols = list(c('1uM_mean.dmso', '1uM_mean.c18'),
c('3uM_mean.dmso', '3uM_mean.c18'),
c('10uM_mean.dmso', '10uM_mean.c18'))
dose_ranges = list(c(0.7,1.3), c(2.1, 3.9), c(7,13))
doses = c('1uM', '3uM', '10uM')
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, cell_id=NA, outcome_dmso=NA, outcome_c18=NA, mean_response=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
minR = min(conductance, na.rm=TRUE)
#if(!any(is.na(conductance)) && all(conductance > 0.8)){
if(!is.na(minR) && minR > 0.8){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2], mean(conductance, na.rm=TRUE)))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
info = info[-1,]
info
minR
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, cell_id=NA, outcome_dmso=NA, outcome_c18=NA, mean_response=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
minR = min(conductance, na.rm=TRUE)
#if(!any(is.na(conductance)) && all(conductance > 0.8)){
if(is.finite(minR) && minR > 0.8){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert, doses[j], conductance[1], conductance[2], mean(conductance, na.rm=TRUE)))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
info = info[-1,]
warnings()
info
S$sm = lapply(meanSigs, function(x){out = laply(x, identity); rownames(out) = names(x); return(out)})
rownames(S$sm)
rownames(S$sm$none)
dim(info)
rownames(info) = rownames(S$sm$none)
info
# Identify relevant experiments (measured drug/dose combinations with conductance not too low)
C = drugData$outcomes
dose_cols = list(c('1uM_mean.dmso', '1uM_mean.c18'),
c('3uM_mean.dmso', '3uM_mean.c18'),
c('10uM_mean.dmso', '10uM_mean.c18'))
dose_ranges = list(c(0.7,1.3), c(2.1, 3.9), c(7,13))
doses = c('1uM', '3uM', '10uM')
meanSigs = list()
allInfo = list()
info = data.frame(pert_id=NA, dose=NA, outcome_dmso=NA, outcome_c18=NA, mean=NA, max=NA)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
minR = min(conductance, na.rm=TRUE)
#if(!any(is.na(conductance)) && all(conductance > 0.8)){
if(is.finite(minR) && minR > 0.8){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert_id=pert, dose=doses[j],
outcome_dmso=conductance[1], outcome_c18=conductance[2],
mean=mean(conductance, na.rm=TRUE), max=max(conductance, na.rm=TRUE)))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
# Some post-processing
S$sm = lapply(meanSigs, function(x){out = laply(x, identity); rownames(out) = names(x); return(out)})
info = info[-1,]
rownames(info) = rownames(S$sm$none)
?ifelse
# Binarize outcomes in info:
info$result = 'inconclusive'
info$result[info$max >= 1.25] = 'active'
info$result[info$max < 1.2] = 'inactive'
info
varPart = fitExtractVarPartModel(S$sm$none, ~outcome_dmso , info)
dim(S$sm$none)
dim(info)
fitExtractVarPartModel
?fitExtractVarPartModel
S$sm$none
dim(S$sm$none)
varPart = fitExtractVarPartModel(t(S$sm$none), ~outcome_dmso, info)
dim(t(S$sm$none))
head(info)
info$outcome_dmso
lapply(info, class)
meanSigs = list()
allInfo = list()
fill = -999
info = data.frame(pert_id=NA, dose=NA, outcome_dmso=fill, outcome_c18=fill, mean=fill, max=fill)
for(i in 1:length(drugData$metadata$pert_id)){
pert = drugData$metadata$pert_id[i]
print(pert)
for(j in 1:3){
pdInfo = subset(sigInfo, pert_id == pert & pert_dose >= dose_ranges[[j]][1]
& pert_dose <= dose_ranges[[j]][2])
if(nrow(pdInfo) > 0){
conductance = as.numeric(C[i, dose_cols[[j]]])
minR = min(conductance, na.rm=TRUE)
#if(!any(is.na(conductance)) && all(conductance > 0.8)){
if(is.finite(minR) && minR > 0.8){
pd = paste(pert, doses[j], sep='_')
# average signature
meanSigs$none[[pd]] = apply(S$lg$none[rownames(pdInfo),], 2, mean)
meanSigs$batch[[pd]] = apply(S$lg$batch[rownames(pdInfo),], 2, mean)
meanSigs$both[[pd]] = apply(S$lg$both[rownames(pdInfo),], 2, mean)
# get metadata: cell_ids, pert_doses, and outcomes
info = rbind(info, c(pert_id=pert, dose=doses[j],
outcome_dmso=conductance[1], outcome_c18=conductance[2],
mean=mean(conductance, na.rm=TRUE), max=max(conductance, na.rm=TRUE)))
# store extended metadata for reference
allInfo[[pd]] = pdInfo
}
}
}
}
# Some post-processing
S$sm = lapply(meanSigs, function(x){out = laply(x, identity); rownames(out) = names(x); return(out)})
info = info[-1,]
rownames(info) = rownames(S$sm$none)
# Binarize outcomes in info:
info$result = 'inconclusive'
info$result[info$max >= 1.25] = 'active'
info$result[info$max < 1.2] = 'inactive'
varPart = fitExtractVarPartModel(t(S$sm$none), ~outcome_dmso, info)
info$outcome_dmso
info$max
class(info)
info$max >= 1.25
lapply(info, class)
tmp = info
cols = c('outcome_dmso', 'outcome_c18', 'mean', 'max', 'result')
info[,cols] = lapply(info[,cols], as.numeric)
info
info = tmp
tmp
info
cols = c('outcome_dmso', 'outcome_c18', 'mean', 'max')
info[,cols] = lapply(info[,cols], as.numeric)
info
info$outcome_dmso
varPart = fitExtractVarPartModel(t(S$sm$none), ~outcome_dmso, info)
vp = sortCols(varPart)
vp
varPart
vp = varPart
vp[order(vp$outcome_dmso),]
vp[order(vp$outcome_dmso, decreasing=TRUE),]
vp[order(vp$outcome_dmso, decreasing=TRUE)[1:30],]
vp = sortCols(varPart)
plotPercentBars(vp[order(vp$outcome_dmso,decreasing=TRUE)[1:30],])
plotVarPart(vp)
plotVarPart(vp[,1])
vp[,1]
hist(varPart$outcome_dmso)
head(info)
v_dmso = varPart
v_c18 = fitExtractVarPartModel(t(S$sm$none), ~outcome_c18, info)
hist(v_c18)
hist(v_c18$outcome_c18)
cor(v_c18$outcome_c18, v_dmso$outcome_dmso)
plot(v_c18$outcome_c18, v_dmso$outcome_dmso)
v_mean = fitExtractVarPartModel(t(S$sm$none), ~mean, info)
v_max = fitExtractVarPartModel(t(S$sm$none), ~max, info)
info_sub = subset(info, result %in% c('active', 'inactive'))
info_sub
A = S$sm$none[rownames(info_sub),]
dim(A)
dim(S$sm$none)
v_bin = fitExtractVarPartModel(t(A), ~result, info_sub)
V = data.frame(dmso=v_dmso$outcome_dmso, c18=v_c18$outcome_c18,
mean=v_mean$mean, max=v_max$max, binary=v_bin$result)
plotVarPart(V)
?sample
sample(nrow(info))
sample(nrow(info), replace=FALSE)
set.seed(123)
set.seed(123)
v_rand = list()
for(i in 1){
info_shuf = info[sample(nrow(info)),]
v_rand[[i]] = fitExtractVarPartModel(t(S$sm$none), ~outcome_c18, info_shuf)
}
hist(v_rand[[i]]$outcome_c18)
V$rand1 = v_rand[[1]]$outcome_c18
plotVarPart(V)
cor(V$dmso, V$rand1)
cor(V$dmso, V$c18)
for(i in 2){
info_shuf = info[sample(nrow(info)),]
v_rand[[i]] = fitExtractVarPartModel(t(S$sm$none), ~outcome_c18, info_shuf)
}
V[[paste0('rand', str(i))]] = v_rand[[i]]$outcome_c18
plotVarPart(V)
cor(V$rand1, V$rand)
cor(V$binary, V$dmso)
paste0('rand', str(i))
paste0('rand', i)
names(V)
save(V, OutputDir('active_v_inactive/variance_partition_take1.RData'))
save(V, file=OutputDir('active_v_inactive/variance_partition_take1.RData'))
minCutoff = .5
ggsave(file=PlotDir(sprintf('varPart_%0.2fcutoff_no_correction.pdf', 0.8)))
plotVarPart(V, main='Percent of explained variance per gene, no batch correction')
plotVarPart(V, main=sprintf('No batch correction, min cutoff = %0.2f', 0.8))
ggsave(file=PlotDir(sprintf('varPart_%0.2fcutoff_no_correction.pdf', 0.8)))
dir = OutputDir('active_v_inactive')
minCutoff = .5
source('~/Box Sync/CFDR/cfdr/code/R/scripts/compare_sigs/get_relevant_L1000_sigs_for_CF_active_inactive_analysis.R')
A = data.frame(x=0)
A$y = rep(1, 10)
A
dim(S$sm)
dim(S$sm$none)
?gage
library(gage)
?gage
?pca
?svd
rm(list=ls())
getwd()
setwd('~/Desktop/Research/LINCS/submission/dgc_predict')
testAll = FALSE
source('R/init.R')
n=load(ResultsDir('sda_debug.RData'))
n
ROC = ROC_save
ROC
R = melt(ROC)
R
names(R) = c('ROC', 'eval', 'obs', 'feature', 'label')
names(R) = c('ROC', 'eval', 'obs', 'feature', 'label')
R
R = melt(ROC, id.vars=c('L3','L1'))
dim(R)
head(R)
R = melt(ROC)#, id.vars=c('L3','L1'))
dim(R)
R
R = melt(ROC)#, id.vars=c(3,5))
dim(R)
R
R = melt(ROC, id.vars=c(3,5))#, id.vars=c(3,5))
dim(R)
R
S = cast(R, label ~ obs)
R = melt(ROC)
names(R) = c('ROC', 'eval', 'obs', 'feature', 'label')
S = cast(R, label ~ obs)
head(R)
S = cast(R, ROC ~ obs)
S
R = melt(ROC)
names(R) = c('ROC', 'eval', 'obs', 'feature', 'label')
R
R_eval_meas = subset(R, eval=='eval_meas')
R_eval_meas
dcast(R_eval_meas, ROC ~ obs)
dcast(R_eval_meas, ROC ~ obs, value.var=ROC)
dcast(R_eval_meas, ROC ~ obs, value.var='ROC')
dcast(R_eval_meas, obs ~ ROC)
R_eval_meas
dcast(R_eval_meas, eval + feature + label ~ ROC)
dcast(R_eval_meas, ROC ~ eval + feature + label)
dcast(R_eval_meas, ROC ~ obs)
R_eval_meas
dcast(R_eval_meas, feature + label ~ ROC, subset = (obs=="obs") )
dcast(R_eval_meas, feature + label + obs ~ ROC, subset = (obs=="obs") )
dcast(R_eval_meas, feature + label ~ ROC, subset = (variable=="obs") )
head(R_eval_meas)
dcast(R_eval_meas, feature + label + obs ~ ROC, subset = (obs=="obs") )
dcast(R_eval_meas, feature + label + obs ~ ROC, subset = (R_eval_meas$obs=="obs") )
?dcast
dcast(R_eval_meas, feature + label + obs ~ ROC, subset = .(obs=="obs") )
dcast(R_eval_meas, feature + label ~ obs, subset = .(obs=="obs") )
dcast(R_eval_meas, feature + label ~ obs)
Rmeas = subset(R, eval=='eval_meas')
Rmeas$
S = cast(R, ROC ~ obs)
Rmeas
a = b = 1
a
b
